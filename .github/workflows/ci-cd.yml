name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ '*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  frontend-quality:
    name: Frontend Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - run: yarn install --frozen-lockfile
      - run: yarn lint
      - run: yarn test --coverage

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  backend-quality:
    name: Backend Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - run: chmod +x ./gradlew
      - run: ./gradlew --no-daemon citest jacocoTestReport

      - uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/build/reports/jacoco/
          retention-days: 7

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: java,javascript
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: frontend-quality
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - run: yarn install --frozen-lockfile
      - run: yarn build

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 3

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [ build-frontend, backend-quality ]
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist

      - name: Embed frontend assets
        run: |
          rm -rf src/main/resources/static
          mkdir -p src/main/resources/static
          cp -r ../frontend-dist/* src/main/resources/static/

      - uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - run: chmod +x ./gradlew
      - run: ./gradlew --no-daemon --quiet clean shadowJar

      - uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/build/libs/*.jar
          retention-days: 3

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: .

      - name: Normalize JAR
        run: mv $(ls *.jar | head -n1) knca-signer.jar

      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'frontend'
          ignore-unfixed: true

      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'backend'
          ignore-unfixed: true
          vuln-type: 'library'

      - run: docker build -t knca-signer:scan .

      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          scan-ref: 'knca-signer:scan'
          ignore-unfixed: true

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: security-scan
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: .

      - name: Prepare artifacts
        run: |
          mv $(ls *.jar | head -n1) knca-signer.jar
          sha256sum knca-signer.jar | tee knca-signer.jar.sha256
          sha512sum knca-signer.jar | tee knca-signer.jar.sha512

      - uses: actions/attest-build-provenance@v1
        with:
          subject-path: knca-signer.jar

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate release notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          {
            echo "## Docker Image"
            echo "\`ghcr.io/${{ github.repository }}\`"
            echo ""
            echo "## Checksums"
            echo "\`\`\`"
            cat knca-signer.jar.sha256
            cat knca-signer.jar.sha512
            echo "\`\`\`"
            echo ""
            echo "## Changes"
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
              git log --pretty=format:"- %s (%h)" ${LAST_TAG}..HEAD
            else
              git log --pretty=format:"- %s (%h)" HEAD
            fi
          } > release_notes.md

      - uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: release_notes.md
          files: |
            knca-signer.jar
            knca-signer.jar.sha256
            knca-signer.jar.sha512
